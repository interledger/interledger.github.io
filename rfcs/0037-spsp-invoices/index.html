<!DOCTYPE html>
<html lang="en">
<head>
    <!-- <base href="https://jakeatdocforce.github.io/interledger-dactyl/"> -->
    <!-- <base href="http://localhost:8000/"> -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="The protocol for connecting blockchains and other ledgers">

    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

    <!-- Custom styles -->
    <link href="/assets/css/custom.css" rel="stylesheet">

    <!-- Google fonts -->
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,300,200,600,700|Droid+Sans+Mono|Titillium+Web:400,300,600' rel='stylesheet' type='text/css'>

    <link href="/assets/favicon.png" rel="icon" type="image/x-icon">

    <!--  highlight js -->
    <link rel="stylesheet" href="/assets/css/monokai-sublime.css">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->




</head>

<body class="xrp-ledger-dev-portal sidebar-primary ">

  <div class="container">
        <nav class="navbar fixed-top navbar-expand-lg navbar-dark nav-innerpage">
            <div class="navbar-leftbg"><a href="/index.html" class="navbar-brand"><img src="/assets/img/ilp_logo.png" class="logo"  height="44" alt="Interledger" /></a></div>
            <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbarHolder" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <!-- <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar"> -->

              <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse justify-content-end" id="navbarHolder">
              <ul class="nav navbar-nav">
                    <li class="nav-item" ><a class="nav-link" href="/overview.html">Docs</a></li>
                    <li class="nav-item" ><a class="nav-link" href="/libraries.html">Tools</a></li>
                    <li class="nav-item" ><a class="nav-link" href="/community.html">Community</a></li>
                    <li class="nav-item"><a class="nav-link" target="_blank" href="https://github.com/interledger">Edit on Github</a></li>
                    <li class="nav-item"><a class="nav-link cornerlink" href="/getting-started.html">Get Started</a></li>
              </ul><!-- /.navbar-nav -->
              <div class="cornerbox"></div>
            </div>
            <div class="menu-overlay"></div>
        </nav>
    </div>

    <div class="container-fluid" role="document" id="main_content_wrapper">
        <div class="row">

        <aside class="sidebar col-md-5 col-lg-3 p-0 order-md-1" role="complementary">

    <div id="sidenav" class="tree_nav">
      <ul class=" sidebar_pagelist">
        <li class="nav-label">Quick Start</li>
        <li><a href="/overview.html">Overview</a></li>
        <li><a href="/getting-started.html">Getting Started</a></li>
      </ul>
      <ul class=" sidebar_pagelist">
        <li class="nav-label">Community Resources</li>
        <li><a href="https://medium.com/interledger-blog">Blog &amp; Tutorials</a></li>
        <li><a href="/libraries.html">Libraries &amp; Tools</a></li>
        <li><a href="/summit-2019.html">ILP Summit 2019 Videos</a></li>
      </ul>

      <div class="sidebar-nav-header">Specs</div>
      <ul class=" sidebar_pagelist sidebar_indent">
        <!--    <li><a href="/rfcs/0001-interledger-architecture/">Interledger Architecture</a></li> -->
        <li><a href="/rfcs/0027-interledger-protocol-4/">Interledger Protocol 4 (ILPv4)</a></li>
        <li><a href="/rfcs/0015-ilp-addresses/">Interledger Addresses</a></li>
        <li><a href="/rfcs/0029-stream/">STREAM Protocol</a></li>
        <li><a href="/rfcs/0009-simple-payment-setup-protocol/">Simple Payment Setup Protocol (SPSP)</a></li>
        <li><a href="/rfcs/0026-payment-pointers/">Payment Pointers</a></li>
        <li><a href="/rfcs/0028-web-monetization/">Web Monetization</a></li>
        <li><a href="/rfcs/0030-notes-on-oer-encoding/">Notes on OER encoding</a></li>
        <li><a href="/rfcs/0031-dynamic-configuration-protocol/">Dynamic Configuration Protocol (ILDCP)</a></li>
        <li><a href="/rfcs/0032-peering-clearing-settlement/">Peering, Clearing and Settlement</a></li>
        <li><a href="/rfcs/0035-ilp-over-http/">ILP over HTTP</a></li>
        <li><a href="/rfcs/0036-spsp-pull-payments/">SPSP Pull Payments</a></li>
        <li><a target="_blank" href="https://w3c.github.io/webpayments/proposals/interledger-payment-method.html">W3C Web Payments</a></li>

      </ul>
    </div>        </aside>

          <!-- main column -->
        <main class="main col-md-7 col-lg-6 order-md-3  " role="main" id="main_content_body">
  <article class="pt-3 p-md-3">
    <div class="content doc-content">
        <h1 id="spsp-invoices">SPSP Invoices</h1>
<h2 id="preface">Preface</h2>
<p>This document describes how conduct an Invoice Payment via <a href="/rfcs/0029-stream/">STREAM</a> once the payment details have been exchanged via the <a href="/rfcs/0009-simple-payment-setup-protocol/">Simple Payment Setup Protocol</a> (SPSP).</p>
<h2 id="introduction">Introduction</h2>
<h3 id="invoice-payments">Invoice Payments</h3>
<p>An Invoice Payment is a push payment to an Invoice SPSP Endpoint that allows the Payer (sender) to settle outstanding balances with the Payee (receiver). The Invoice SPSP Endpoint MAY expose the details about the Invoice and, when receiving value, updates its outstanding balance accordingly.</p>
<h3 id="motivation">Motivation</h3>
<p>The <a href="/rfcs/0009-simple-payment-setup-protocol/">Simple Payment Setup Protocol</a> (SPSP) only describes how the details required for a STREAM connection are exchanged and how simple push payments are made. Invoices require the SPSP server to keep track of incoming payments, i.e. act as an accounting server. </p>
<h3 id="scope">Scope</h3>
<p>This document specifies Invoice specific endpoints on SPSP and payments to these. They are intended for wallet providers and merchants.</p>
<h3 id="definitions">Definitions</h3>
<ul>
<li><strong>Invoice</strong> - A set of parameters describing the nature of the value transfer as well as its terms and status.</li>
<li><strong>Invoice Payment</strong> - The process of completing an Invoice by transferring value to its corresponding Invoice SPSP Endpoint.</li>
<li><strong>Payer</strong> - The entity that is sending units of value to an Invoice SPSP Endpoint on the Payee's <a href="/rfcs/0009-simple-payment-setup-protocol/#Definitions">SPSP Server</a>. It is running the <a href="/rfcs/0009-simple-payment-setup-protocol/#Definitions">SPSP Client</a>.</li>
<li><strong>Payee</strong> - The entity that is creating an Invoice SPSP Endpoint and receives units of value from the Payer using this Invoice SPSP Endpoint. It is running the <a href="/rfcs/0009-simple-payment-setup-protocol/#Definitions">SPSP Server</a>.</li>
<li><strong>Invoice Payment Pointer</strong> - A <a href="/rfcs/0026-payment-pointers/">Payment Pointer</a> that includes a unique and opaque string and represents an Invoice. The SPSP Client uses it to query the <a href="/rfcs/0009-simple-payment-setup-protocol/#Definitions">SPSP Endpoint</a> on the SPSP Server, which MAY expose the details of the Invoice. It is the means by which the Payee keeps track of incoming payments. </li>
</ul>
<h3 id="operation-overview">Operation Overview</h3>
<p>The Payer's SPSP Client will set up a <a href="/rfcs/0029-stream/">STREAM</a> connection to the Payee's SPSP Server using the Invoice Payment Pointer, as described by the <a href="/rfcs/0009-simple-payment-setup-protocol/">Simple Payment Setup Protocol</a>. On connection, the SPSP Client pushes as much value to the SPSP Server as necessary to complete the Invoice.</p>
<h2 id="model-of-operation">Model of Operation</h2>
<h3 id="creating-an-invoice-payment-pointer">Creating an Invoice Payment Pointer</h3>
<p>Prior to the Invoice Payment, the Payee has to create the Invoice Payment Pointer representing the Invoice. This Invoice Payment Pointer MUST be unique to the Invoice. The Payee's SPSP Server SHOULD store the Invoice details associated to the Invoice Payment Pointer, which are defined in the <code>invoice</code>-object within the <a href="#Response-Body">Response Body</a>, in order to account for balance changes.</p>
<h3 id="conducting-an-invoice-payment">Conducting an Invoice Payment</h3>
<p>The Payer's SPSP Client opens a <a href="/rfcs/0029-stream/">STREAM</a> connection to the Payee's SPSP Server as described in the <a href="/rfcs/0009-simple-payment-setup-protocol/">Simple Payment Setup Protocol</a>. Once this connection is established, the process continues as follows: </p>
<p>The SPSP Client begins sending ILP packets using the STREAM protocol to complete the Invoice.
  1. The SPSP Client will adjust their <code>sendMax</code> to reflect the amount they're willing to send.
      * <code>sendMax</code> SHOULD be derived from the Invoice, i.e., <code>sendMax</code> SHOULD be equal to <code>push.invoice.amount - push.balance</code>, converted to the SPSP Client's operating asset, plus a buffer to take exchange rate fluctuations and connector fees into account.
  2. The SPSP Server will adjust their <code>receiveMax</code> to reflect the amount they're willing to receive.
      * <code>receiveMax</code> SHOULD be derived from the Invoice, i.e., <code>sendMax</code> SHOULD be equal to <code>push.invoice.amount - push.balance</code>, converted to the SPSP Server's operating asset, plus a buffer to take exchange rate fluctuations into account.
  3. The SPSP Client's and Server's <a href="/rfcs/0009-simple-payment-setup-protocol/#Definitions">STREAM Modules</a> will move as much value as possible while staying inside these bounds.
  4. If the SPSP Client reaches their <code>sendMax</code>, they end the stream and the connection. If the SPSP Server reaches their <code>receiveMax</code>, they will end the stream and the connection. Furthermore, when the SPSP Server has received enough value to fully pay the invoice, it ends the stream and the connection. In both cases, the connection is closed with a <code>NoError</code> code in the <code>ConnectionClose</code> frame.</p>
<p>The STREAM parameters--<code>sendMax</code> and <code>receiveMax</code>--as well as the <code>ConnectionClose</code> frame are defined in <a href="/rfcs/0029-stream/#53-frames">STREAM's frame encoding</a>.</p>
<h2 id="specification">Specification</h2>
<h3 id="query-get-ltspsp-endpointgt">Query (<code>GET &lt;SPSP Endpoint&gt;</code>)</h3>
<p>The SPSP Client queries the Invoice Payment Pointer to get information about the SPSP Server as well as Invoice specific details:</p>
<h4 id="request">Request</h4>
<pre><code class="http">GET /invoice123 HTTP/1.1
Host: example.com
Accept: application/spsp4+json
</code></pre>
<h4 id="response">Response</h4>
<pre><code class="http">HTTP/1.1 200 OK
Content-Type: application/spsp4+json

{
  "destination_account": "example.ilpdemo.red.invoice123",
  "shared_secret": "6jR5iNIVRvqeasJeCty6C+YB5X9FhSOUPCL/5nha5Vs=",
  "push": {
    "balance": "5360",
    "invoice": {
      "amount": "19999",
      "asset": {
        "code": "USD",
        "scale": 2
      },
      "additional_fields": {
        "description": "Chair model 'Rustic'",
        "receiver": "The Red Furniture Store"
      }
    }
  }
}
</code></pre>
<h5 id="response-body">Response Body</h5>
<p>The response body is a JSON object that includes basic account details necessary for setting up a STREAM connection as well as optional parameters for displaying purposes. The fields are defined in the following: </p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>destination_account</code></td>
<td><a href="/rfcs/0015-ilp-addresses/">ILP Address</a></td>
<td>(see <a href="/rfcs/0009-simple-payment-setup-protocol/#Response-Body">Simple Payment Setup Protocol</a>)</td>
</tr>
<tr>
<td><code>shared_secret</code></td>
<td>32 bytes, <a href="https://en.wikipedia.org/wiki/Base64">base64 encoded</a> (including padding)</td>
<td>(see <a href="/rfcs/0009-simple-payment-setup-protocol/#Response-Body">Simple Payment Setup Protocol</a>)</td>
</tr>
<tr>
<td><code>push</code></td>
<td>Object</td>
<td>Details of this specific push payment pointer.</td>
</tr>
<tr>
<td><code>push.balance</code></td>
<td>String Integer</td>
<td>Amount, denoted in <code>push.invoice.asset.code</code>, which completes the invoice payment.</td>
</tr>
<tr>
<td><code>push.invoice</code></td>
<td>Object</td>
<td>Invoice details.</td>
</tr>
<tr>
<td><code>push.invoice.amount</code></td>
<td>String Integer</td>
<td>Amount, denoted in <code>push.invoice.asset.code</code>, which needs to be received in order for the invoice to be considered as paid.</td>
</tr>
<tr>
<td><code>push.invoice.asset</code></td>
<td>Object</td>
<td>Details about the Invoice's asset.</td>
</tr>
<tr>
<td><code>push.invoice.asset.code</code></td>
<td>String</td>
<td>Asset code to identify the Invoice's currency. Currencies that have <a href="https://en.wikipedia.org/wiki/ISO_4217">ISO 4217</a> codes should use those.</td>
</tr>
<tr>
<td><code>push.invoice.asset.scale</code></td>
<td>Integer</td>
<td>The scale of the amounts denoted in <code>push.invoice.asset.code</code> (e.g. an amount of <code>"1000"</code> with a scale of <code>2</code> translates to <code>10.00</code> units of the SPSP server's asset/currency).</td>
</tr>
<tr>
<td><code>push.invoice.additional_fields</code></td>
<td>Object</td>
<td><em>(OPTIONAL)</em> Any additional information the Payee wants to include.</td>
</tr>
</tbody>
</table>
<p><strong>Note:</strong> Currency amounts are denominated as integer strings instead of native JSON numbers to avoid losing precision during JSON parsing. Applications MUST represent these numbers in a data type that has precision equal or greater than an unsigned 64-bit integer.</p>
<h5 id="errors">Errors</h5>
<h6 id="pointer-does-not-exist">pointer Does Not Exist</h6>
<pre><code class="http">HTTP/1.1 404 Not Found
Content-Type: application/spsp4+json

{
  "id": "InvalidPointerError",
  "message": "Pointer does not exist."
}
</code></pre>
    </div>
  </article>
        </main>

        <aside class="right-sidebar col-lg-3 order-lg-4 p-0" role="complementary">
  <div class="card" id="page-toc-wrapper">
    <div class="card-header">
      <h4>On This Page</h4>
    </div>
    <ul class="card-body">
      <li class="level-1"><a href="#spsp-invoices">SPSP Invoices</a></li>
<li class="level-2"><a href="#preface">Preface</a></li>
<li class="level-2"><a href="#introduction">Introduction</a></li>
<li class="level-3"><a href="#invoice-payments">Invoice Payments</a></li>
<li class="level-3"><a href="#motivation">Motivation</a></li>
<li class="level-3"><a href="#scope">Scope</a></li>
<li class="level-3"><a href="#definitions">Definitions</a></li>
<li class="level-3"><a href="#operation-overview">Operation Overview</a></li>
<li class="level-2"><a href="#model-of-operation">Model of Operation</a></li>
<li class="level-3"><a href="#creating-an-invoice-payment-pointer">Creating an Invoice Payment Pointer</a></li>
<li class="level-3"><a href="#conducting-an-invoice-payment">Conducting an Invoice Payment</a></li>
<li class="level-2"><a href="#specification">Specification</a></li>
<li class="level-3"><a href="#query-get-ltspsp-endpointgt">Query ( GET &lt;SPSP Endpoint&gt; )</a></li>

    </ul>
  </div>
        </aside>

        </div><!--/.row (main layout)-->
      </div>


<footer>
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <div class="col-sm-10 col-xs-12 float-left">
                    <img src="/assets/img/footerlogo.png">
                </div>
                <div class="col-sm-2 col-xs-12 float-right">
                    <a href="https://twitter.com/interledger"><img src="/assets/img/Twitter.png"></a>
                    <a href="https://communityinviter.com/apps/interledger/interledger-working-groups-slack"><img src="/assets/img/Slack.png"></a>
                </div>
            </div>
        </div>
    </div>
</footer>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="/assets/js/bootstrap.min.js"></script>
<script src="/assets/js/custom.js"></script>
<script src="/assets/js/highlight.pack.js"></script>
<script src="/assets/js/home.js"></script>
<script type="text/javascript" src="/assets/js/svg-animation.js"></script>

<!-- <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-68500608-1', 'auto');
    ga('send', 'pageview');

</script> -->

</body>
</html>